<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>My Vault</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-store">

<link rel="stylesheet" href="css/style.css">
</head>

<body>

<header>
  <h2>ğŸ— My Vault</h2>
  <div class="top-actions">
    <button id="lockBtn">ğŸ”’ Lock</button>
    <button id="bioBtn">ğŸ§¬ Biometric</button>
  </div>
</header>

<hr>

<section class="add-box">
  <select id="category">
    <option value="game">ğŸ® Game</option>
    <option value="social">ğŸŒ Social</option>
    <option value="work">ğŸ’¼ Work</option>
    <option value="other">ğŸ“ Other</option>
  </select>

  <input id="title" placeholder="à¸Šà¸·à¹ˆà¸­ / à¸šà¸±à¸à¸Šà¸µ">
  <input id="secret" placeholder="à¸£à¸«à¸±à¸ª / à¹‚à¸™à¹‰à¸•">

  <button id="saveBtn">ğŸ’¾ Save</button>
</section>

<hr>

<section class="tools">
  <button id="exportBtn">ğŸ“¤ Export</button>
  <button id="importBtn">ğŸ“¥ Import</button>
  <input type="file" id="importFile" hidden>
</section>

<hr>

<section>
  <ul id="list"></ul>
</section>

<footer>
  <small>ğŸ” Zero-Knowledge Vault Â· Client-Side Only</small>
</footer>

<!-- ================= SCRIPTS ================= -->
<script type="module">
/* ---------- IMPORT ---------- */
import "./js/lock.js";
import { lockNow } from "./js/lock.js";
import { enableBio } from "./js/biometric.js";
import { exportVault, importVault } from "./js/export.js";
import { openDB } from "./js/db.js";
import { deriveKey, encrypt, decrypt } from "./js/crypto.js";

/* ---------- SESSION CHECK ---------- */
const session = JSON.parse(sessionStorage.getItem("vault_key"));
if (!session) lockNow();

/* ---------- KEY DERIVE ---------- */
const master = prompt("ğŸ”‘ à¹ƒà¸ªà¹ˆ Master Password");
if (!master) lockNow();

const salt = new Uint8Array(session.salt);
const key = await deriveKey(master, salt);

/* ---------- ELEMENTS ---------- */
const list = document.getElementById("list");
const category = document.getElementById("category");
const title = document.getElementById("title");
const secret = document.getElementById("secret");

/* ---------- LOAD ITEMS ---------- */
async function loadItems() {
  const db = await openDB();
  const tx = db.transaction("items");
  const store = tx.objectStore("items");

  store.getAll().onsuccess = async e => {
    list.innerHTML = "";

    for (const item of e.target.result) {
      const li = document.createElement("li");
      li.className = "item";

      const text = document.createElement("span");
      text.textContent = `${item.category} | ${item.title}`;

      const showBtn = document.createElement("button");
      showBtn.textContent = "ğŸ‘";
      showBtn.onclick = async () => {
        const plain = await decrypt(item.cipher, item.iv, key);
        showBtn.textContent = plain;
        setTimeout(() => showBtn.textContent = "ğŸ‘", 3000);
      };

      li.appendChild(text);
      li.appendChild(showBtn);
      list.appendChild(li);
    }
  };
}

/* ---------- SAVE ITEM ---------- */
document.getElementById("saveBtn").onclick = async () => {
  if (!secret.value || !title.value) return alert("à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š");

  const db = await openDB();
  const { cipher, iv } = await encrypt(secret.value, key);

  db.transaction("items", "readwrite")
    .objectStore("items")
    .add({
      category: category.value,
      title: title.value,
      cipher,
      iv
    });

  secret.value = "";
  loadItems();
};

/* ---------- EXPORT / IMPORT ---------- */
document.getElementById("exportBtn").onclick = exportVault;

document.getElementById("importBtn").onclick = () =>
  document.getElementById("importFile").click();

document.getElementById("importFile").onchange = e =>
  importVault(e.target.files[0]).then(loadItems);

/* ---------- LOCK / BIO ---------- */
document.getElementById("lockBtn").onclick = lockNow;
document.getElementById("bioBtn").onclick = enableBio;

/* ---------- INIT ---------- */
loadItems();
</script>

</body>
</html>
